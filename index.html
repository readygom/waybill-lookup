<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>운송장 조회</title>
  <style>
    :root{
      --bg:#0b1220;
      --bg2:#0f172a;
      --card:#111827;
      --muted:#94a3b8;
      --text:#e5e7eb;
      --brand:#06b6d4;
      --accent:#f59e0b;
      --ok:#22c55e;
      --danger:#ef4444;
      --ring: rgba(6, 182, 212, .35);
      --radius: 16px;
    }
    *{box-sizing:border-box}
    body{margin:0; background:linear-gradient(180deg,var(--bg),var(--bg2)); color:var(--text); font-family:ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans KR", Helvetica, Arial, "Apple SD Gothic Neo", "Malgun Gothic", "Nanum Gothic", "Apple Color Emoji", "Segoe UI Emoji";}
    .wrap{max-width:1024px; margin:40px auto; padding:0 20px}
    header{display:flex; gap:16px; align-items:center; margin-bottom:20px}
    .logo{width:40px; height:40px; border-radius:10px; background:radial-gradient(120% 120% at 20% 20%, var(--brand), #2563eb); box-shadow:0 10px 30px rgba(6,182,212,.35)}
    h1{font-size:24px; margin:0}
    .card{background:linear-gradient(180deg,rgba(255,255,255,.04),rgba(255,255,255,.015)); border:1px solid rgba(255,255,255,.08); border-radius:var(--radius); padding:20px; box-shadow:0 10px 35px rgba(0,0,0,.35)}
    .hint{color:var(--muted); font-size:14px}
    .grid{display:grid; grid-template-columns:1fr; gap:16px}
    @media(min-width:860px){.grid{grid-template-columns:1fr}}
    .input{width:100%; padding:14px 14px; border-radius:12px; background:#0b1220; color:var(--text); border:1px solid rgba(255,255,255,.12); outline:none}
    .input:focus{border-color:var(--brand); box-shadow:0 0 0 6px var(--ring)}
    .row{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
    .btn{appearance:none; border:none; border-radius:12px; padding:12px 16px; background:var(--brand); color:#042f2e; font-weight:700; cursor:pointer}
    .btn.ghost{background:transparent; border:1px solid rgba(255,255,255,.15); color:var(--text)}
    .btn:disabled{opacity:.5; cursor:not-allowed}
    .result{display:grid; gap:12px; margin-top:14px}
    .item{display:flex; flex-wrap:wrap; gap:10px; justify-content:space-between; align-items:center; background:#0b1220; border:1px solid rgba(255,255,255,.08); border-radius:12px; padding:14px}
    .item strong{font-size:16px}
    .tag{font-size:12px; color:var(--muted)}
    .carrier{font-weight:700; color:var(--accent)}
    a.link{color:#93c5fd; text-decoration:none}
    a.link:hover{text-decoration:underline}
    .note{font-size:12px; color:var(--muted)}
    .kbd{font-family:ui-monospace,monospace; background:#0b1220; border:1px solid rgba(255,255,255,.12); padding:2px 6px; border-radius:6px}
    footer{margin:28px 0; text-align:center; color:var(--muted); font-size:12px}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="logo" aria-hidden></div>
      <div>
        <h1>운송장 조회</h1>
        <div class="hint">이름 또는 연락처(숫자 일부)로 검색하면 운송장 번호가 표시됩니다.</div>
      </div>
    </header>

    <section class="card">
      <label for="q" class="hint">검색어</label>
      <div class="row" style="margin-top:6px">
        <input id="q" class="input" placeholder="예: 김수현 / 0107166… (숫자 일부만 입력해도 됨)" />
        <button id="btnSearch" class="btn">조회</button>
        <button id="btnRefresh" class="btn ghost" title="구글 시트에서 새로 불러오기">새로고침</button>
      </div>
      <div id="stats" class="hint" style="margin-top:6px"></div>
      <div id="result" class="result"></div>
    </section>

    <footer>© <span id="year"></span> 운송장 간편 조회</footer>
  </div>

  <script>
    const CONFIG = {
      mode: 'csv',
      csvUrl: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vT0AhuyvpRKGxCw1pH3wDGYGmFPgJPV5og1m3jLJByUBzjmLJVG1QhKHoKTpQTsCWIqZWTp2Ox71go3/pub?output=csv',
      appsScriptUrl: ''
    };

    let DB = [];
    const $ = (q)=>document.querySelector(q);
    const year = new Date().getFullYear(); (document.querySelector('#year')||{}).textContent = year;

    const CARRIER_LINKS = {
      'CJ대한통운': (no) => `https://track.cjlogistics.com/ko/tracking?slipno=${encodeURIComponent(no)}`,
      '한진택배': (no) => `https://www.hanjin.co.kr/kor/CMS/DeliveryMgr/WaybillResult.do?mCode=MN038&schLang=KR&billno=${encodeURIComponent(no)}`,
      '롯데택배': (no) => `https://www.lotteglogis.com/home/reservation/tracking/linkView?InvNo=${encodeURIComponent(no)}`,
      '로젠택배': (no) => `https://www.ilogen.com/web/personal/trace/${encodeURIComponent(no)}`,
      '우체국택배': (no) => `https://service.epost.go.kr/trace.RetrieveDomRigiTraceList.comm?sid1=${encodeURIComponent(no)}`,
    };

    function render(items){
      const result = $('#result');
      result.innerHTML = '';
      if(!items.length){
        result.innerHTML = `<div class="hint">검색 결과가 없습니다.</div>`;
        return;
      }
      for(const it of items){
        const no = it.tracking_no||'';
        const carrier = it.carrier||'';
        const link = no ? (CARRIER_LINKS[carrier] ? CARRIER_LINKS[carrier](no) : `https://www.google.com/search?q=${encodeURIComponent((carrier||'운송장')+' '+no)}`) : '';
        const el = document.createElement('div');
        el.className = 'item';
        el.innerHTML = `
          <div>
            <strong>${it.receiver||'-'}</strong>
            <div class="tag">연락처: ${it.phone||'-'}</div>
            ${it.shop ? `<div class="tag">서점명: ${it.shop}</div>`:''}
            ${it.date ? `<div class="tag">출고일자: ${it.date}</div>`:''}
            <div class="tag">주소: ${it.address||'-'}</div>
            <div class="tag">비고: ${it.note||'-'}</div>
          </div>
          <div style="text-align:right">
            <div class="carrier">${carrier||'택배사 미지정'}</div>
            <div class="tag">운송장: <span class="kbd">${no||'-'}</span></div>
            ${no ? `<a class="link" href="${link}" target="_blank" rel="noopener">택배사에서 조회하기 →</a>` : `<span class="hint">운송장 준비중</span>`}
          </div>`;
        result.appendChild(el);
      }
    }

    function normalizePhone(s){ return String(s||'').replace(/\D/g,''); }

    function filterRecords(records, q){
      const f = (q||'').trim().toLowerCase();
      if(!f) return [];
      const fnum = normalizePhone(q);
      return (records||[]).filter(r=>{
        const byName = String(r.receiver||'').toLowerCase().includes(f);
        const byPhone = normalizePhone(r.phone).includes(fnum) && fnum.length>0;
        return byName || byPhone;
      });
    }

    function search(){
      const q = $('#q').value;
      const out = filterRecords(DB, q);
      render(out);
      $('#stats').textContent = q.trim()? `${out.length}건이 검색되었습니다.` : '';
    }

    $('#btnSearch').addEventListener('click', search);
    $('#q').addEventListener('keydown', e=>{ if(e.key==='Enter') search(); });

    function parseCSV(text){
      const rows = [];
      let i=0, field='', row=[], inQuotes=false;
      while(i<text.length){
        const c = text[i];
        if(c==='"'){
          if(inQuotes && text[i+1]==='"'){ field+='"'; i++; }
          else inQuotes = !inQuotes;
        }else if(c===',' && !inQuotes){ row.push(field); field=''; }
        else if((c==='\n' || c==='\r') && !inQuotes){ if(field!==''||row.length){ row.push(field); rows.push(row); row=[]; field=''; } }
        else{ field+=c; }
        i++;
      }
      if(field!==''||row.length) { row.push(field); rows.push(row); }
      return rows.filter(r=>r.length>1);
    }

    function rowsToDB(rows){
      if(!rows||!rows.length) return [];
      const header = rows.shift().map(h=>String(h).trim());
      const idxOf = (name)=> header.findIndex(h=>h.replace(/\s/g,'')===name);
      const idx = {
        receiver: idxOf('받는사람'),
        phone: idxOf('연락처'),
        address: idxOf('주소'),
        note: idxOf('비고'),
        tracking_no: idxOf('운송장번호'),
        carrier: Math.max(idxOf('택배사'), header.findIndex(h=>/택배|carrier/i.test(h))),
        date: Math.max(idxOf('출고일자'), header.findIndex(h=>/출고.?일자|date/i.test(h))),
        shop: Math.max(idxOf('서점명'), header.findIndex(h=>/서점|shop|store/i.test(h)))
      };
      return rows.map(r=>(
        {
          receiver: r[idx.receiver]||'',
          phone: r[idx.phone]||'',
          address: r[idx.address]||'',
          note: r[idx.note]||'',
          tracking_no: r[idx.tracking_no]||'',
          carrier: idx.carrier>=0? r[idx.carrier]||'': '',
          date: idx.date>=0? r[idx.date]||'': '',
          shop: idx.shop>=0? r[idx.shop]||'': ''
        }
      )).filter(x=> x.receiver || x.phone || x.tracking_no);
    }

    async function fetchCSV(url){
      const res = await fetch(url, { cache:'no-store' });
      if(!res.ok) throw new Error(`CSV fetch failed: ${res.status}`);
      const text = await res.text();
      return rowsToDB(parseCSV(text));
    }

    async function loadData(){
      try{
        if(CONFIG.mode==='csv' && !looksLikeValidUrl(CONFIG.csvUrl)){
          return;
        }
        DB = await fetchCSV(CONFIG.csvUrl);
        render([]);
      }catch(err){
        console.error(err);
      }
    }

    $('#btnRefresh').addEventListener('click', loadData);

    function runTests(){
      const out=[]; let pass=0, fail=0; const log=(ok,msg)=>{ ok?pass++:fail++; out.push(`${ok?'✅':'❌'} ${msg}`); };
      (function(){ const csv='받는사람,연락처\n"김,가은",010-1234\n'; const rows=parseCSV(csv); log(rows.length===2 && rows[1][0]==='김,가은','T1 parseCSV quoted comma'); })();
      (function(){ const rows=[["받는사람","연락처","주소","비고","운송장번호","택배사"],["홍길동","010-0000-0000","서울","메모","0099","CJ대한통운"]]; const db=rowsToDB(rows); log(db.length===1 && db[0].tracking_no==='0099' && db[0].carrier==='CJ대한통운','T2 rowsToDB map'); })();
      (function(){ const db=[{receiver:'김가은',phone:'010-1234-5678'},{receiver:'박민수',phone:'010-9999-0000'}]; const a=filterRecords(db,'김'); const b=filterRecords(db,'9999'); log(a.length===1 && a[0].receiver==='김가은','T3-1 name includes'); log(b.length===1 && b[0].receiver==='박민수','T3-2 phone partial'); })();
      const summary=`\n결과: ${pass} PASS / ${fail} FAIL`; console.log(summary); return {pass,fail};
    }
    runTests();
  </script>
</body>
</html>
